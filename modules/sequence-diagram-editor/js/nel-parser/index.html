<!DOCTYPE html>
<html>
<head>
    <title>ANTLR on the Web</title>
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <script type="text/javascript" src="lib/required_js/require.js"></script>
    <script>
var eventOrigin;
        function receiveMessage(event)
       {
           document.getElementById("test").innerHTML = "received: "+event.data;
           eventOrigin = event.origin || event.originalEvent.origin;
           var source = event.data;
           generateTreeObject(source);
           console.log(event.data);
           event.source.postMessage(
                   generatedTree,
                   "http://localhost:63342/wso2-tooling"
           );
        }
        window.addEventListener("message", receiveMessage, false);
    </script>
    <script type="text/javascript">
        function sendMessage() {
            var win = document.getElementById("iframe").contentWindow;

            win.postMessage(
                    generatedTree,
                    "http://localhost:63342/wso2-tooling"
            );
            console.log("sent message from 2nd view");
        }

    </script>
</head>
<body>
<div id="test">Send me a message!</div>

<div id="inputs">
<!--<textarea id="code">-->
<!--* play with antlr4-->
<!--* write a tutorial-->
<!--</textarea>-->
    <!--<br />-->
    <button id="parse">Parse</button>

</div>
<script type="text/javascript">
    var  generatedTree;
    var antlr4 = require('antlr4/index');
    var NELLexer = require('generated-parser/NELLexer');
    var NELParser = require('generated-parser/NELParser');
    var NELListener = require('js/NELListenerImpl');

    document.getElementById("parse").addEventListener("click", function () {

//        var input = "@Path(\"/onHeaderStocks\")"+
//        "@Source(interface = \"default\")"+
//        "@Service(tags = {"+
//            "\"stock_info\","+
//            "\"stock_update\""+
//        "}, description = \"Rest api for get stocks details\", produces = MediaType.APPLICATION_JSON)"+
//        "package com.sample;"+
//        "constant endpoint stockIBMEP = new EndPoint(\"http://localhost:8080/stockquote/IBM\");"+
////        "constant endpoint stockAllEP = new EndPoint(\"http://localhost:8080/stockquote/all\");"+
////        "constant endpoint integrationEP = new EndPoint(\"http://localhost:9090/onHeaderStocks/stocksResource\");"+
//        "@GET"+
//        "@PUT"+
//        "@POST"+
//        "@Path(\"/IBMStocks\")"+
//        "resource getStocks(message m) {"+
//            "message response;"+
//            "log(level = \"custom\", status = \"Message Received at setHeaderResource\");"+
//
//            "log(level = \"custom\", status = \"Setting IBM to the request message header\");"+
//            "setHeader(messageRef = m, headerName = \"exchange\", headerValue = \"IBM\");"+
//
//            "response = invoke(endpointRef = integrationEP, messageRef = m);"+
//
//            "log(level = \"custom\", status = \"Response sent back to client...\");"+
//            "reply response;"+
//        "}"+
//
//        "@GET"+
//        "@PUT"+
//        "@POST"+
//        "@Path(\"/stocksResource\")"+
//        "resource invokeBackend(message m) {"+
//            "message response;"+
//            "log(level = \"custom\", status = \"Message Received at getStocksResource\");"+
//
//            "if (eval(messageRef = m, path = \"$header.exchange\") == \"IBM\") {"+
//                "log(level = \"custom\", status = \"IBM exchange found in message headers\");"+
//                "response = invoke(endpointRef = stockIBMEP, messageRef = m);"+
//            "} else {"+
//                "log(level = \"custom\", status = \"IBM exchange not found in message headers\");"+
//                "response = invoke(endpointRef = stockAllEP, messageRef = m);"+
//            "}"+
//            "reply response;"+
//        "}";
//        var input = "@Path(\"/stocks\")" +
//                    "@Source(interface=\"default\")" +
//                    "@Service(tags = {" +
//                    "\"stock_info\"," +
//                    "\"stock_update\"" +
//                    "}, description = \"Rest api for get stocks details\", produces = MediaType.APPLICATION_JSON)" +
//                    "package com.sample;" +
//                    "constant endpoint stockEP = new EndPoint(\"http://localhost:8080/stockquote/all\");" +
//                    "@GET" +
//                    "@PUT" +
//                    "@POST" +
//                    "@Path(\"/getStocks\")" +
//                    "resource passthrough(message m) {" +
//                    "message response;" +
//                    "response = invoke(endpointRef=stockEP, messageRef=m);" +
//                    "reply response;" +
//                    "}";

//        var input = "@Path(\"/stocks\")" +
//                    "@Source(interface=\"default\")" +
//                    "@Service(tags = {" +
//                    "\"stock_info\"," +
//                    "\"stock_update\"" +
//                    "}, description = \"Rest api for get stocks details\", produces = MediaType.APPLICATION_JSON)" +
//                    "package com.sample;" +
//                    "constant endpoint stockEP = new EndPoint(\"http://localhost:8080/stockquote/all\");" +
//                    "@GET" +
//                    "@PUT" +
//                    "@POST" +
//                    "@Path(\"/getStocks\")" +
//                    "resource passthrough(message m) {" +
//                    "message response;" +
//                    "log(level=\"custom\", status=\"Message Received...\");" +
//                    "response = invoke(endpointRef=stockEP, messageRef=m);" +
//                    "reply response;" +
//                    "}";

//        var input = "@Path(\"/commonStocks\")"+
//        "@Source(interface=\"default\")"+
//        "@Service(tags = {"+
//            "\"stock_info\","+
//            "\"stock_update\""+
//        "}, description = \"Rest api for get stocks details\", produces = MediaType.APPLICATION_JSON)"+
//        "package com.sample;"+
//        "constant endpoint stockEP = new EndPoint(\"http://localhost:8080/stockquote/all\");"+
//        "@GET"+
//        "@PUT"+
//        "@POST"+
//        "@Path(\"/getStocksWithHeader\")"+
//        "resource filter(message m) {"+
//            "message response;"+
//            "log(level=\"custom\", status=\"Message Received...\");"+
//            "if (eval(messageRef=m, path=\"$header.exchange\") == \"NYSE\") {"+
//                "if (eval(messageRef=m, path=\"$header.sub.exchange\") == \"ONE\") {"+
//                    "log(level=\"custom\", status=\"Exchange NYSE, sub-exchange ONE\");"+
//                "} else {"+
//                    "log(level=\"custom\", status=\"Exchange NYSE, sub-exchange not ONE\");"+
//                "}"+
//            "} else {"+
//                "if (eval(messageRef=m, path=\"$header.sub.exchange\") == \"ONE\") {"+
//                    "log(level=\"custom\", status=\"Exchange not NYSE, sub-exchange ONE\");"+
//                "} else {" +
//                    "log(level=\"custom\", status=\"Exchange not NYSE, sub-exchange not ONE\");"+
//                "}"+
//            "}"+
//            "log(level=\"custom\", status=\"Message sent to Endpoint...\");"+
//            "response = invoke(endpointRef=stockEP, messageRef=m);"+
//            "log(level=\"custom\", status=\"Response sent back to client...\");"+
//            "reply response;"+
//        "}";

//        var input = "@Path(\"/commonStocks\")"+
//                    "@Source(interface=\"default\")"+
//                    "@Service(tags = {"+
//                    "\"stock_info\","+
//                    "\"stock_update\""+
//                    "}, description = \"Rest api for get stocks details\", produces = MediaType.APPLICATION_JSON)"+
//                    "package com.sample;"+
//                    "constant endpoint stockEP = new EndPoint(\"http://localhost:8080/stockquote/all\");"+
//                    "@GET" +
//        "@PUT" +
//        "@POST" +
//        "@Path(\"/stocksResource\")" +
//        "resource invokeBackend(message m) {" +
//            "message response;" +
//            "log(level = \"custom\", status = \"Message Received at getStocksResource\");" +
//
//            "if (eval(messageRef = m, path = \"$header.exchange\") == \"IBM\") {"+
//                "log(level = \"custom\", status = \"IBM exchange found in message headers\");"+
//                "response = invoke(endpointRef = stockIBMEP, messageRef = m);"+
//            "} else {"+
//                "log(level = \"custom\", status = \"IBM exchange not found in message headers\");"+
//                "response = invoke(endpointRef = stockAllEP, messageRef = m);"+
//            "}"+
//            "reply response;"+
//        "}";

        var input = "@Path (\"/stock\")"+
        "@Source (interface=\"x\")"+
        "@Service(tags = {\"stock_info\",\"stock_update\"}, description = \"Rest api for do operations on admin\", produces = MediaType.APPLICATION_JSON)"+
        "package com.sample;"+
        "constant endpoint stockEP = new Endpoint(\"http://localhost:8080/exchange/\");"+
        "@GET"+
        "@PUT"+
        "@POST"+
        "@Path (\"/passthrough\")"+
        "resource passthrough (message m) {"+
            "message response;"+
            "try {"+
                    "log(level = \"custom\", status = \"Message Received at getStocksResource\");" +
                "response = invoke(messageRef = m, endpointRef = stockEP);"+
            "} catch (Exception e) {"+
//                "response = new message();"+
                "setHeader(messageRef = response, headerName = \"HTTP.StatusCode\", headerValue = 500);"+
            "}"+
            "reply response;"+
        "}";

        var chars = new antlr4.InputStream(input);
        var lexer = new NELLexer.NELLexer(chars);
        var tokens = new antlr4.CommonTokenStream(lexer);
        var parser = new NELParser.NELParser(tokens);
        var listener = new NELListenerImpl();
        parser.buildParseTrees = true;
        var tree = parser.sourceFile();
        var x = antlr4.tree.ParseTreeWalker.DEFAULT.walk(listener, tree);
    });
    function generateTreeObject(source) {
        var antlr4 = require('antlr4/index');
        var NELLexer = require('generated-parser/NELLexer');
        var NELParser = require('generated-parser/NELParser');
        var NELListener = require('js/NELListenerImpl');

        var chars = new antlr4.InputStream(source);
        var lexer = new NELLexer.NELLexer(chars);
        var tokens = new antlr4.CommonTokenStream(lexer);
        var parser = new NELParser.NELParser(tokens);
        var listener = new NELListenerImpl();
        parser.buildParseTrees = true;
        var tree = parser.sourceFile();
        var x = antlr4.tree.ParseTreeWalker.DEFAULT.walk(listener, tree);
    }
</script>
<div id="tree">
</div>
</body>
<iframe src="http://localhost:63342/wso2-tooling/modules/sequence-diagram-editor/index.html" id="iframe"
        style="height:60px"></iframe>
</html>